# Pipeline parameters
parameters:

  - name: SERVICE_CONN
    type: string
    default: IaCAgent-ClinicalMDR-DEV

steps:

  - script: |
      # Ensure none of the current composed services are running
      docker compose down --volumes
  
      # Remove all unused local volumes, which are not referenced by any containers.
      docker volume prune -f
    displayName: "Reset docker environment"

  - task: AzureCLI@2
    displayName: Log in to container registry
    inputs:
      azureSubscription: ${{parameters.SERVICE_CONN}}
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        az acr login -n '$(azmd.acrname)'

  - script: |
      docker compose build api --build-arg BUILD_TARGET=prod --build-arg PYTHON_IMAGE=$(azmd.acrname).azurecr.io/novo-python-3-7-12-slim:latest --progress=plain
    displayName: "Build api docker image"

  - script: |    
      docker compose up --detach --renew-anon-volumes
    displayName: "Start docker services"
