# Pipeline parameters
parameters:

  - name: SERVICE_CONN
    type: string
    default: IaCAgent-ClinicalMDR-DEV

steps:

  - script: |
      set -ex
      
      # Ensure none of the current composed services are running
      docker compose down --volumes
  
      # Remove all unused local volumes, which are not referenced by any containers.
      docker volume prune -f
    displayName: "Reset docker environment"

  - task: AzureCLI@2
    displayName: Log in to container registry
    inputs:
      azureSubscription: ${{parameters.SERVICE_CONN}}
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: >-
        az acr login -n '$(azmd.acrname)'

  - script: |
      set -ex
      docker compose build --progress=plain api \
        --build-arg BUILD_TARGET=prod \
        --build-arg PYTHON_IMAGE='$(azmd.acrname).azurecr.io/novo-python-3-11-3-slim:latest' \
        --build-arg BUILD_NUMBER='$(Build.BuildNumber)' \
        --build-arg BUILD_BRANCH='$(Build.SourceBranchName)' \
        --build-arg BUILD_COMMIT='$(Build.SourceVersion)'
    displayName: "Build api docker image"

  - script: |
      set -ex
      docker compose up --detach --renew-anon-volumes --wait database
      docker compose up --detach --wait api
    displayName: "Start docker services"
